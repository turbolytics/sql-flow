kafka:
  brokers: [localhost:9092]
  group_id: test
  auto_offset_reset: earliest

tables:
  sql:
    - name: agg_cities_count
      sql: |
        CREATE TABLE agg_cities_count (
          timestamp TIMESTAMP,
          city VARCHAR,
          count INT 
        );
        CREATE UNIQUE INDEX daily_cities_count_idx ON agg_cities_count (timestamp, city);

      # tables can be managed as a windowed table.
      # windowed tables flush the table at certain durations.
      window:
        type: tumbling
        duration_seconds: 10

        output:
          type: console

pipeline:
  type: 'handlers.TumblingWindow'

  input:
    batch_size: 1000
    topics:
    - "tumbling-window"

  sql: |
    INSERT INTO agg_cities_count
    BY NAME
    SELECT 
      timestamp::date as timestamp,
      properties.city as city,
      count(*) as count
    FROM batch
    GROUP BY 
      timestamp, city
    ON CONFLICT (timestamp, city) 
    DO UPDATE SET count = count + EXCLUDED.count